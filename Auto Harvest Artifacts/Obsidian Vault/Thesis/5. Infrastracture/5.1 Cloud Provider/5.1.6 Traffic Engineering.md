The traffic engineering strategy for Auto Harvest focuses on ensuring **secure, reliable, and scalable routing** of HTTP(S) and MQTT traffic across environments. The system leverages a hybrid model of **Google Cloud Load Balancers** and **Cloudflare edge routing** to manage ingress, optimize performance, and enhance security.

#### üåê Subdomain-Based Routing

We use a domain-based routing model to separate service concerns and support future extensibility:

- **`api.autoharvest.solutions`**: Primary API entrypoint for the React Native client and dashboard interface.
    
- **`mqtt-<hash>.autoharvest.solutions`**: Dedicated endpoint for firmware-to-broker communication using MQTT over TCP.
    

These subdomains are managed via **Cloudflare DNS**, providing global propagation and built-in DDoS protection.

#### üß≠ Hybrid Load Balancing

Incoming traffic first hits **Cloudflare**, which acts as:

- DNS resolver
    
- TLS terminator (with Full SSL enforcement)
    
- Firewall and WAF layer
    

Requests are then routed to **Google Cloud Load Balancers**, which forward traffic to the GKE cluster via `LoadBalancer`-type Kubernetes services. This two-layer setup provides a balance between performance, control, and security.

#### üîê TLS and SSL Handling

We enforce **Strict SSL mode** at Cloudflare, which requires a valid certificate on the origin (GCP). GCP certificates are automatically provisioned and managed by the HTTP(S) Load Balancer, ensuring end-to-end encrypted connections between client ‚Üí Cloudflare ‚Üí GCP.

This configuration prevents traffic from bypassing Cloudflare and reaching the backend directly.

#### ‚öñÔ∏è Isolation and Routing Logic

While current deployments expose one service per endpoint, future routing strategies may introduce **URL map routing** through GCP‚Äôs backend services (e.g., `/api1`, `/api2` on a shared domain). At present, each service is individually routed and exposed via its own Load Balancer and subdomain.

Stage and production environments are isolated via **different buckets and CI workflows**, but share similar traffic routing logic.

#### üõ°Ô∏è Abuse Mitigation

Traffic filtering is largely managed at the Cloudflare layer:

- **Rate Limiting**: Helps mitigate abuse or repeated request floods.
    
- **CORS Headers**: Defined to only allow specific origins.
    
- **Security Challenges**: Cloudflare‚Äôs bot detection automatically blocks suspicious patterns (e.g., scans for `.env`, `wp-config.php`).
    
- **‚ÄúI‚Äôm Under Attack‚Äù Mode**: Provides CAPTCHA protection during potential DDoS spikes.
    

Internally, GCP does not impose additional request throttling ‚Äî this is delegated to Cloudflare, reducing compute costs and load on backend services.

#### ‚ö†Ô∏è Limitations Encountered

One notable limitation was encountered while attaching multiple backends (or paths) to a single Load Balancer. GCP's Ingress controller often failed to provision static IP addresses properly under the free tier, which occasionally blocked deployment. These edge cases were resolved by switching to standalone Load Balancer deployments per service.